<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ Панель</title>
  <link rel="stylesheet" href="./assets/css/require.css">
  <link rel="stylesheet" href="./assets/css/admin.css">
  <script>
    // Проверка пароля перед загрузкой страницы
    const password = prompt("Введите пароль для доступа к админ панели:");
    if (password !== "password123") {
      alert("Неверный пароль. Доступ запрещен!");
      window.location.href = "./index.html"; // Возврат на главную страницу
    }
  </script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h3 class="headline-md">Админ Панель</h3>
    </div>
  </header>

  <main>
    <section class="admin-panel">
      <div class="container">
        <h2 class="headline-md">Список зарегистрированных пользователей</h2>
        <table id="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Имя</th>
              <th>Фамилия</th>
              <th>Контакт</th>
              <th>Telegram</th>
              <th>Тип участия</th>
              <th>Эмоция</th>
              <th>Роль</th>
              <th>Дата регистрации</th>
            </tr>
          </thead>
          <tbody>
            <!-- Сюда будут загружены данные -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const usersTableBody = document.querySelector('#users-table tbody');

    async function fetchUsers() {
      try {
        const response = await fetch("https://677cf63a4496848554c85fe7.mockapi.io/users/users");
        const users = await response.json();

        usersTableBody.innerHTML = ''; // Очищаем таблицу

        users.forEach(user => {
          const telegramLink = user.telegramUserName
            ? `<a href="#" onclick="return openTelegram('${user.telegramUserName}')">${user.telegramUserName}</a>`
            : '-';

          const createdAt = formatDate(user.createdAt);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.firstName || '-'}</td>
            <td>${user.lastName || '-'}</td>
            <td>${user.contactInfo || '-'}</td>
            <td>${telegramLink}</td>
            <td>${user.performanceType || '-'}</td>
            <td>${user.emotion || '-'}</td>
            <td>${user.role}</td>
            <td>${createdAt}</td>
          `;
          usersTableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
        alert('Не удалось загрузить данные пользователей.');
      }
    }

    // Функция для форматирования даты
    function formatDate(dateString) {
      try {
        let date = new Date(dateString);
        if (isNaN(date)) {
          date = new Date(dateString.replace(' ', 'T')); // Попытка преобразовать вручную
        }
        if (isNaN(date)) throw new Error("Invalid date");

        return date.toLocaleString('ru-RU', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
        });
      } catch (error) {
        console.error('Ошибка форматирования даты:', error);
        return 'Некорректная дата';
      }
    }

    // Функция для открытия Telegram
    function openTelegram(username) {
      const telegramAppLink = `tg://resolve?domain=${username}`;
      const fallbackLink = `https://t.me/${username}`;

      const openApp = window.open(telegramAppLink, '_self');
      setTimeout(() => {
        if (!openApp || openApp.closed || typeof openApp.closed == 'undefined') {
          window.location.href = fallbackLink;
        }
      }, 500);

      return false; // Предотвращаем переход по ссылке
    }

    // Загружаем данные при загрузке страницы
    fetchUsers();
  </script>
</body>

</html>
